{
    "name": "BambiGO_L2_Weather_Sync_All_Nodes",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "minutes",
                            "minutes": 10
                        }
                    ]
                }
            },
            "id": "schedule_trigger",
            "name": "排程觸發 (10min)",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [
                200,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m",
                "options": {}
            },
            "id": "open_meteo_weather",
            "name": "Fetch Tokyo Weather",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                400,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "const weather = $input.first().json.current;\nconst now = new Date().toISOString();\n\n// Target Stations (All MVP Nodes)\nconst stations = [\n  'odpt:Station:TokyoMetro.Ueno',\n  'odpt:Station:TokyoMetro.Asakusa',\n  'odpt:Station:JR-East.Akihabara',\n  'odpt:Station:JR-East.Tokyo',\n  'odpt:Station:TokyoMetro.Ginza',\n  'odpt:Station:Toei.Kuramae',\n  'odpt:Station:Toei.ShinOkachimachi',\n  'odpt:Station:Toei.Ningyocho',\n  'odpt:Station:JR-East.Kanda',\n  'odpt:Station:Toei.Nihombashi',\n  'odpt:Station:TokyoMetro.Mitsukoshimae',\n  'odpt:Station:Toei.HigashiGinza',\n  'odpt:Station:TokyoMetro.Tawaramachi',\n  'odpt:Station:TokyoMetro.Iriya',\n  'odpt:Station:JR-East.Uguisudani',\n  'odpt:Station:Toei.Asakusabashi',\n  'odpt:Station:TokyoMetro.Kayabacho',\n  'odpt:Station:TokyoMetro.Kasumigaseki',\n  'odpt:Station:TokyoMetro.Iidabashi',\n  'odpt:Station:TokyoMetro.Ochanomizu',\n  'odpt:Station:TokyoMetro.Minowa',\n  'odpt:Station:TokyoMetro.Kyobashi',\n  'odpt:Station:TokyoMetro.Otemachi',\n  'odpt:Station:JR-East.Okachimachi'\n];\n\n// Map weather code to Condition String\nfunction getWeatherCondition(code) {\n  if (code <= 3) return 'Clear';\n  if (code <= 48) return 'Cloudy';\n  if (code <= 67) return 'Rain';\n  if (code <= 77) return 'Snow';\n  return 'Unknown';\n}\n\nreturn stations.map(stationId => ({\n  json: {\n    station_id: stationId,\n    status_code: 'NORMAL', // Default for now\n    reason_ja: null,\n    weather_info: {\n      temp: weather.temperature_2m,\n      condition: getWeatherCondition(weather.weather_code),\n      wind: weather.wind_speed_10m,\n      update_time: now\n    },\n    updated_at: now\n  }\n}));"
            },
            "id": "prepare_bulk_data",
            "name": "Prepare Bulk Data",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                600,
                300
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://evubeqeaafdjnuocyhmb.supabase.co/rest/v1/transit_dynamic_snapshot",
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "{{SUPABASE_ANON_KEY}}"
                        },
                        {
                            "name": "Authorization",
                            "value": "Bearer {{SUPABASE_ANON_KEY}}"
                        },
                        {
                            "name": "Prefer",
                            "value": "resolution=merge-duplicates"
                        }
                    ]
                },
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={{ $json }}"
            },
            "id": "supabase_bulk_upsert",
            "name": "Supabase Bulk Upsert",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                800,
                300
            ]
        }
    ],
    "connections": {
        "schedule_trigger": {
            "main": [
                [
                    {
                        "node": "open_meteo_weather",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "open_meteo_weather": {
            "main": [
                [
                    {
                        "node": "prepare_bulk_data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "prepare_bulk_data": {
            "main": [
                [
                    {
                        "node": "supabase_bulk_upsert",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}