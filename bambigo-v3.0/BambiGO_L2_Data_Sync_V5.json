{
    "name": "BambiGO_L2_Data_Sync_V5_GTFS",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "minutes",
                            "minutes": 10
                        }
                    ]
                }
            },
            "id": "schedule_trigger",
            "name": "Trigger (Every 10m)",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [
                100,
                300
            ]
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "SUPABASE_KEY",
                            "value": "YOUR_SUPABASE_KEY_HERE"
                        }
                    ]
                }
            },
            "id": "config_node",
            "name": "üîß Config",
            "type": "n8n-nodes-base.set",
            "typeVersion": 1,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current=temperature_2m,relative_humidity_2m,weather_code",
                "options": {}
            },
            "id": "open_meteo_weather",
            "name": "1. Weather",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                400,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api.odpt.org/api/v4/odpt:TrainInformation?odpt:operator=odpt.Operator:TokyoMetro&acl:consumerKey=ntf1ryl3xiy9lgmf5qsyef04xa9pl8jfx01l669mjtoru6s3xi3zd6xt7kqn19iw",
                "options": {}
            },
            "id": "metro_info",
            "name": "2. Metro Info (JSON)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                550,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api-public.odpt.org/api/v4/odpt:TrainInformation?odpt:operator=odpt.Operator:Toei",
                "options": {}
            },
            "id": "toei_info",
            "name": "3. Toei Info (JSON)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                700,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api.odpt.org/api/v4/gtfs/realtime/toei_odpt_train_alert?acl:consumerKey=ntf1ryl3xiy9lgmf5qsyef04xa9pl8jfx01l669mjtoru6s3xi3zd6xt7kqn19iw",
                "options": {},
                "responseFormat": "file"
            },
            "id": "toei_gtfs",
            "name": "4. Toei GTFS (Binary)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                850,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api.odpt.org/api/v4/gtfs/realtime/tokyometro_odpt_train_alert?acl:consumerKey=ntf1ryl3xiy9lgmf5qsyef04xa9pl8jfx01l669mjtoru6s3xi3zd6xt7kqn19iw",
                "options": {},
                "responseFormat": "file"
            },
            "id": "metro_gtfs",
            "name": "5. Metro GTFS (Binary)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1000,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api-challenge.odpt.org/api/v4/gtfs/realtime/jreast_odpt_train_trip_update?acl:consumerKey=8q0zbz99brwjt46mowbqs2e15ebiajv0d5f9qbjd4ndids493s1vta30bxmcjbgg",
                "options": {},
                "responseFormat": "file"
            },
            "id": "jr_gtfs",
            "name": "6. JR GTFS (Binary)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1150,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api-public.odpt.org/api/v4/odpt:Train?odpt:operator=odpt.Operator:Toei",
                "options": {}
            },
            "id": "toei_train_pos",
            "name": "7. Toei Position",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1300,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api-challenge.odpt.org/api/v4/odpt:Train?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=8q0zbz99brwjt46mowbqs2e15ebiajv0d5f9qbjd4ndids493s1vta30bxmcjbgg",
                "options": {}
            },
            "id": "jr_train_pos",
            "name": "8. JR Position",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1450,
                300
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://evubeqeaafdjnuocyhmb.supabase.co/rest/v1/transit_dynamic_snapshot",
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "={{ $node[\"config_node\"].json[\"SUPABASE_KEY\"] }}"
                        },
                        {
                            "name": "Authorization",
                            "value": "={{ 'Bearer ' + $node[\"config_node\"].json[\"SUPABASE_KEY\"] }}"
                        },
                        {
                            "name": "Prefer",
                            "value": "resolution=merge-duplicates"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"station_id\": \"odpt:Station:TokyoMetro.Ueno\",\n  \"status_code\": \"{{ ($node['metro_info'].json[0]?.['odpt:trainInformationText']?.ja?.includes('ÈÅÖ„Çå') || $node['toei_info'].json[0]?.['odpt:trainInformationText']?.ja?.includes('ÈÅÖ„Çå')) ? 'DELAY' : 'NORMAL' }}\",\n  \"reason_ja\": \"Metro: {{ $node['metro_info'].json[0]?.['odpt:trainInformationText']?.ja || 'OK' }} | Toei: {{ $node['toei_info'].json[0]?.['odpt:trainInformationText']?.ja || 'OK' }}\",\n  \"reason_zh_tw\": null,\n  \"weather_info\": {\n    \"temp\": \"{{ $node['open_meteo_weather'].json['current']['temperature_2m'] }}\",\n    \"condition\": \"{{ $node['open_meteo_weather'].json['current']['weather_code'] == 0 ? 'Clear' : 'Rain' }}\",\n    \"update_time\": \"{{ $now }}\"\n  },\n  \"updated_at\": \"{{ $now }}\"\n}"
            },
            "id": "final_db_update",
            "name": "9. Aggregated DB Update",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1600,
                300
            ]
        }
    ],
    "connections": {
        "schedule_trigger": {
            "main": [
                [
                    {
                        "node": "config_node",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "config_node": {
            "main": [
                [
                    {
                        "node": "open_meteo_weather",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "open_meteo_weather": {
            "main": [
                [
                    {
                        "node": "metro_info",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "metro_info": {
            "main": [
                [
                    {
                        "node": "toei_info",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "toei_info": {
            "main": [
                [
                    {
                        "node": "toei_gtfs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "toei_gtfs": {
            "main": [
                [
                    {
                        "node": "metro_gtfs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "metro_gtfs": {
            "main": [
                [
                    {
                        "node": "jr_gtfs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "jr_gtfs": {
            "main": [
                [
                    {
                        "node": "toei_train_pos",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "toei_train_pos": {
            "main": [
                [
                    {
                        "node": "jr_train_pos",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "jr_train_pos": {
            "main": [
                [
                    {
                        "node": "final_db_update",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}