# AI Agent å°è©±åŠŸèƒ½é©—è­‰æ¸¬è©¦

**Epic**: AI Chat / L4 Agent
**Priority**: P0
**Status**: Draft

## 1. Context

æœ¬æ¸¬è©¦è¨ˆåŠƒçš„ç›®æ¨™æ˜¯é€éç€è¦½å™¨å¯¦æ¸¬é©—è­‰ AI Agent çš„å°è©±åŠŸèƒ½ï¼Œæ¶µè“‹ä¸‰å€‹æ ¸å¿ƒé¢å‘ï¼š

1. **åŸºæœ¬å›æ‡‰èƒ½åŠ›**ï¼šç¢ºèª Agent èƒ½æ­£å¸¸å›æ‡‰ç”¨æˆ¶å•é¡Œ
2. **å…§å®¹å“è³ªèˆ‡æº–ç¢ºåº¦**ï¼šé©—è­‰å›æ‡‰å…§å®¹æ˜¯å¦æ­£ç¢ºã€ç›¸é—œä¸”æœ‰åƒ¹å€¼
3. **æ¶æ§‹ç¬¦åˆæ€§**ï¼šç¢ºèªå›æ‡‰æ˜¯å¦æŒ‰ç…§é–‹ç™¼æ¶æ§‹ä½¿ç”¨å·¥å…·ã€æŠ€èƒ½ã€API ç­‰æ•¸æ“šèˆ‡çŸ¥è­˜

### ç³»çµ±æ¶æ§‹æ¦‚è¿°

AI Agent æ¶æ§‹æ¡ç”¨ `HybridEngine` å››å±¤æ±ºç­–ç³»çµ±ï¼š
- **L1 Template Engine + POITaggedDecisionEngine**ï¼šå¿«é€ŸåŒ¹é…é è¨­æ¨¡æ¿
- **L2 Algorithm Provider**ï¼šæ¨™æº–æ¼”ç®—æ³•è™•ç†ï¼ˆè·¯ç·šè¦åŠƒã€ç¥¨åƒ¹è¨ˆç®—ï¼‰
- **L3/L4 Deep Research Skills + DataMux**ï¼šæ·±åº¦ AI åˆ†æèˆ‡å°ˆå®¶çŸ¥è­˜

é—œéµå…ƒä»¶ï¼š
- [`HybridEngine.ts`](file:///Users/zhuangzixian/Documents/LUTAGU_MVP/src/lib/l4/HybridEngine.ts)ï¼šæ ¸å¿ƒå¼•æ“
- [`agentChat.ts`](file:///Users/zhuangzixian/Documents/LUTAGU_MVP/services/chat-api/src/routes/agentChat.ts)ï¼šAPI è·¯ç”±
- [`SkillRegistry`](file:///Users/zhuangzixian/Documents/LUTAGU_MVP/src/lib/l4/skills/SkillRegistry.ts)ï¼šæŠ€èƒ½è¨»å†Š

---

## 2. Test Scenarios

### Scenario 1: åŸºæœ¬å°è©±å›æ‡‰æ¸¬è©¦ (Basic Response)
- **ç›®æ¨™**ï¼šé©—è­‰ Agent èƒ½æ­£å¸¸å›æ‡‰å•é¡Œ
- **Pre-condition**: ç¶²ç«™å·²å•Ÿå‹•ï¼ŒChat Panel å¯é–‹å•Ÿ
- **Steps**:
  1. é–‹å•Ÿ `http://localhost:3003/zh-TW`
  2. é»æ“Š AI åŠ©æ‰‹æŒ‰éˆ•é–‹å•ŸèŠå¤©é¢æ¿
  3. è¼¸å…¥å•é¡Œï¼šã€Œæ±äº¬è»Šç«™æœ‰å“ªäº›å‡ºå£ï¼Ÿã€
  4. ç­‰å¾…å›æ‡‰ï¼ˆæœ€é•· 30 ç§’ï¼‰
- **Expected Result**:
  - âœ… å›æ‡‰å…§å®¹ä¸ç‚ºç©º
  - âœ… å›æ‡‰æ™‚é–“ < 30 ç§’
  - âœ… ç„¡éŒ¯èª¤è¨Šæ¯é¡¯ç¤º
  - âœ… è¨Šæ¯åˆ—è¡¨é¡¯ç¤º 2 æ¢è¨Šæ¯ï¼ˆç”¨æˆ¶ + åŠ©æ‰‹ï¼‰

---

### Scenario 2: è·¯ç·šè¦åŠƒæº–ç¢ºåº¦æ¸¬è©¦ (Route Accuracy)
- **ç›®æ¨™**ï¼šé©—è­‰è·¯ç·šè¦åŠƒå›æ‡‰çš„æ­£ç¢ºæ€§
- **Pre-condition**: åŒä¸Š
- **Steps**:
  1. è¼¸å…¥ï¼šã€Œå¾æ±äº¬è»Šç«™åˆ°æ–°å®¿ç«™æ€éº¼èµ°ï¼Ÿã€
  2. ç­‰å¾…å›æ‡‰
- **Expected Result**:
  - âœ… å›æ‡‰åŒ…å«ä»¥ä¸‹é—œéµè³‡è¨Šä¹‹ä¸€ï¼š
    - ã€Œå±±æ‰‹ç·šã€æˆ–ã€ŒYamanoteã€
    - ã€Œä¸­å¤®ç·šã€æˆ–ã€ŒChuoã€
  - âœ… å›æ‡‰åŒ…å«é ä¼°æ™‚é–“ï¼ˆåˆ†é˜ï¼‰
  - âœ… å›æ‡‰åŒ…å«è½‰ä¹˜è³‡è¨Šï¼ˆå¦‚é©ç”¨ï¼‰

---

### Scenario 3: æ©Ÿå ´äº¤é€šå°ˆå®¶çŸ¥è­˜æ¸¬è©¦ (Airport Expert Knowledge)
- **ç›®æ¨™**ï¼šé©—è­‰ä½¿ç”¨å°ˆå®¶çŸ¥è­˜ (tokyo-expert-knowledge skill)
- **Pre-condition**: åŒä¸Š
- **Steps**:
  1. è¼¸å…¥ï¼šã€Œæˆç”°æ©Ÿå ´åˆ°æ±äº¬ç«™ï¼ŒSkyliner å’Œ N'EX å“ªå€‹æ¯”è¼ƒå¥½ï¼Ÿã€
  2. ç­‰å¾…å›æ‡‰
- **Expected Result**:
  - âœ… å›æ‡‰æ¯”è¼ƒå…©ç¨®äº¤é€šæ–¹å¼
  - âœ… æåŠ Skylinerï¼ˆäº¬æˆï¼‰æˆ– N'EXï¼ˆæˆç”°ç‰¹å¿«ï¼‰
  - âœ… åŒ…å«åƒ¹æ ¼æˆ–æ™‚é–“è³‡è¨Š

---

### Scenario 4: å³æ™‚ç‹€æ…‹æŸ¥è©¢æ¸¬è©¦ (Live Status Query)
- **ç›®æ¨™**ï¼šé©—è­‰ L2 ç‹€æ…‹æŸ¥è©¢åŠŸèƒ½
- **Pre-condition**: åŒä¸Š
- **Steps**:
  1. è¼¸å…¥ï¼šã€Œå±±æ‰‹ç·šç¾åœ¨æœ‰èª¤é»å—ï¼Ÿã€
  2. ç­‰å¾…å›æ‡‰
- **Expected Result**:
  - âœ… å›æ‡‰åŒ…å«é‹è¡Œç‹€æ…‹è³‡è¨Š
  - âœ… å›æ‡‰é¡å‹ç‚ºã€Œç‹€æ…‹ã€ç›¸é—œï¼ˆæ­£å¸¸é‹è¡Œ/å»¶èª¤/åœé§›ï¼‰

---

### Scenario 5: å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡ä¿æŒæ¸¬è©¦ (Multi-turn Context)
- **ç›®æ¨™**ï¼šé©—è­‰å°è©±ä¸Šä¸‹æ–‡èƒ½æ­£ç¢ºä¿æŒ
- **Pre-condition**: åŒä¸Š
- **Steps**:
  1. è¼¸å…¥ï¼šã€Œæˆ‘è¦å»æ·ºè‰ã€
  2. ç­‰å¾…å›æ‡‰
  3. è¼¸å…¥ï¼šã€Œå¾æˆç”°æ©Ÿå ´å‡ºç™¼æ€éº¼å»ï¼Ÿã€
  4. ç­‰å¾…å›æ‡‰
- **Expected Result**:
  - âœ… ç¬¬äºŒè¼ªå›æ‡‰ç†è§£ç›®çš„åœ°æ˜¯ã€Œæ·ºè‰ã€
  - âœ… æä¾›å¾æˆç”°æ©Ÿå ´åˆ°æ·ºè‰çš„è·¯ç·š

---

### Scenario 6: å·¥å…·ä½¿ç”¨é©—è­‰æ¸¬è©¦ (Tool Usage Verification)
- **ç›®æ¨™**ï¼šé€éæ§åˆ¶å°æ—¥èªŒé©—è­‰ Agent ä½¿ç”¨æ­£ç¢ºçš„å·¥å…·/æŠ€èƒ½
- **Pre-condition**: é–‹ç™¼è€…å·¥å…·å·²é–‹å•Ÿ
- **Steps**:
  1. é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…· Console
  2. è¼¸å…¥å•é¡Œï¼šã€Œæ·ºè‰ç«™æœ‰ç½®ç‰©æ«ƒå—ï¼Ÿã€
  3. è§€å¯Ÿæ§åˆ¶å°æ—¥èªŒ
- **Expected Result**:
  - âœ… é¡¯ç¤º `[THINKING]` æ¨™è¨˜ï¼ˆæ€è€ƒéç¨‹ï¼‰
  - âœ… å›æ‡‰åŒ…å«è¨­æ–½ç›¸é—œè³‡è¨Š
  - ğŸ“‹ è¨˜éŒ„æ—¥èªŒä¸­çš„ `decisionSource` å€¼

---

## 3. Data Requirements
- **Mock Data**: Noï¼ˆä½¿ç”¨å¯¦éš› APIï¼‰
- **Environment Variables**:
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `GEMINI_API_KEY` æˆ– `ZEABUR_API_KEY`

---

## 4. Implementation Notes

### ç›®æ¨™æª”æ¡ˆ
- æ¸¬è©¦è¦æ ¼ï¼š`e2e/agent_comprehensive_chat.spec.ts`ï¼ˆæ–°å»ºï¼‰
- åƒè€ƒï¼š`e2e/adk-agent-chat.spec.ts`ï¼ˆç¾æœ‰ï¼‰

### Playwright åŸ·è¡ŒæŒ‡ä»¤
```bash
# é–‹ç™¼æ¸¬è©¦
npx playwright test e2e/agent_comprehensive_chat.spec.ts --headed

# CI æ¨¡å¼
npx playwright test e2e/agent_comprehensive_chat.spec.ts
```

### ç¾æœ‰æ¸¬è©¦è¦†è“‹åˆ†æ
| ç¾æœ‰æ¸¬è©¦ | è¦†è“‹ç¯„åœ |
|---------|---------|
| `adk-agent-chat.spec.ts` | åŸºæœ¬å°è©±ã€å¤šè¼ªã€æ—¥æ–‡èªè¨€ |
| `agent_deep_research.spec.ts` | æ·±åº¦ç ”ç©¶åŠŸèƒ½ |
| `chat_flow.spec.ts` | èŠå¤©æµç¨‹ UI |

### æ–°å¢æ¸¬è©¦é‡é»
1. **å…§å®¹å“è³ªè©•ä¼°**ï¼šé©—è­‰å›æ‡‰åŒ…å«ç‰¹å®šé—œéµè©
2. **æ¶æ§‹ç¬¦åˆæ€§**ï¼šé€éæ§åˆ¶å°æ—¥èªŒé©—è­‰å·¥å…·ä½¿ç”¨
3. **å°ˆå®¶çŸ¥è­˜æ‡‰ç”¨**ï¼šæ©Ÿå ´äº¤é€šæ¯”è¼ƒå ´æ™¯

---

## 5. Execution Plan

| éšæ®µ | è¡Œå‹• | é è¨ˆæ™‚é–“ |
|-----|------|---------|
| 1 | ä½¿ç”¨ç€è¦½å™¨å·¥å…·å¯¦æ¸¬ Scenario 1-6 | 15 åˆ†é˜ |
| 2 | æ”¶é›†æ¸¬è©¦çµæœå’Œæ—¥èªŒ | 5 åˆ†é˜ |
| 3 | ç”¢ç”Ÿé©—è­‰å ±å‘Š | 10 åˆ†é˜ |

---

## 6. User Review Required

> [!IMPORTANT]
> æœ¬æ¸¬è©¦å°‡ä½¿ç”¨ç€è¦½å™¨å·¥å…·å°å¯¦éš›ç¶²ç«™é€²è¡Œæ¸¬è©¦ï¼Œéœ€è¦ï¼š
> 1. ç¢ºèªæœ¬åœ°é–‹ç™¼ä¼ºæœå™¨ (`npm run dev`) å·²å•Ÿå‹•
> 2. ç¢ºèª `.env.local` ç’°å¢ƒè®Šæ•¸å·²é…ç½®
> 3. æ¸¬è©¦å°‡æ¶ˆè€— AI API é…é¡

æ˜¯å¦æ ¸å‡†é€²è¡Œç€è¦½å™¨å¯¦æ¸¬ï¼Ÿ
