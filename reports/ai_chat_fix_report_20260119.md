# LUTAGU AI 對話系統修復報告
**日期**: 2026-01-19
**版本**: v1.0
**狀態**: ✅ 修復完成並通過測試

---

## 問題摘要

用戶輸入「從淺草到東京車站最快的路線」時，系統回傳了模板回應並顯示除錯訊息 "Matched high-frequency pattern/FAQ template."，導致：
1. 無法正確規劃路線
2. 除錯訊息洩漏給用戶
3. 用戶體驗不佳

---

## 根因分析

經過深入探索（Agent Task ID: a590407），發現以下問題鏈條：

### 1. 正則表達式捕獲錯誤
**位置**: services/chat-api/src/lib/l4/HybridEngine.ts (Line 486)

**問題**: 正則表達式將「東京車站最快的路線」整體捕獲為目的地，導致站點名稱解析失敗。

### 2. AlgorithmMatch 信心度門檻過高
**位置**: services/chat-api/src/lib/l4/HybridEngine.ts (Line 199)

門檻 0.8 過高，導致有效結果被拒絕。

### 3. 除錯訊息洩漏
**位置**: services/chat-api/src/routes/agentChat.ts (Line 94-96)

reasoning 欄位直接發送給前端用戶。

---

## 實施的修復

### ✅ 修復 1: 優化正則表達式
- 限制站點名稱長度（1-10 字）
- 排除「的」、「最快」、「路線」等修飾詞
- 新增 trim() 處理

### ✅ 修復 2: 防止除錯訊息洩漏
- 完全移除 reasoning 欄位的前端傳送
- 僅在開發環境記錄到 console

### ✅ 修復 3: 降低信心度門檻
- 從 0.8 降至 0.65
- 允許更多有效結果通過

### ✅ 修復 4: 優化錯誤處理
- 新增 fallback 提示訊息
- 當站點解析成功但無路線時，提供友善錯誤

---

## 測試結果

### ✅ 測試 1: 路線規劃
**輸入**: "從淺草到東京車站最快的路線"
**結果**: "為您找到從 淺草 到 東京車站 的路線建議。"
**狀態**: ✅ 成功

### ✅ 測試 2: 除錯訊息檢查
**輸入**: "你好"
**檢查**: 無 "Matched high-frequency pattern" 訊息
**狀態**: ✅ 成功

### ✅ 測試 3: 設施查詢（回歸）
**輸入**: "上野站有寄物櫃嗎？"
**結果**: 正常回傳設施資訊
**狀態**: ✅ 成功

---

## 部署資訊

```
Service: chat-api
Revision: chat-api-00006-m54
URL: https://chat-api-147810667713.asia-northeast1.run.app
Status: ✅ Serving 100% traffic
```

---

**修復者**: Claude Code
**修復時間**: 2026-01-19 16:00-16:10
**部署狀態**: ✅ 已上線生產環境
