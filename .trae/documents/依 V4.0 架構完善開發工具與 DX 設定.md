## 目標
- 依據 V4.0 架構，補齊 ETL、API、PWA、i18n、測試與開發者體驗（DX）工具，形成可維運的 MVP 作業鏈，並修復已知開發警告。

## 現況
- 已具備：Next 14 App Router、ODPT ETL（scripts/fetch_tokyo_odpt.ts）、DB Schema 與 API `/api/nodes`、PWA manifest、地圖與卡片。
- 警告：開發伺服器提示 workspace root 推斷錯誤（需在 `next.config.ts:3` 設定 turbopack root）。

## 工具與腳本
1) 環境健檢與初始化
- 新增 `scripts/dev_check_env.ts`：檢查 `.env.local` 的 `NEXT_PUBLIC_MAPBOX_TOKEN`、`DATABASE_URL`、`ODPT_API_TOKEN`、`NEXT_PUBLIC_SUPABASE_URL`、`NEXT_PUBLIC_SUPABASE_ANON_KEY` 等，缺漏時列出清單並退出碼 ≠0。
- 新增 `scripts/db_init.ts`：封裝 `init:schema` 執行與 post-check（索引、RLS、extension），輸出總結。
- NPM 腳本：`dev:setup` 順序執行 `dev_check_env` → `db_init`。

2) ODPT ETL 強化
- 將 `scripts/fetch_tokyo_odpt.ts` 參數化：支援 `--bbox`、`--ops=JR-East,TokyoMetro,Toei`、`--dry-run`、`--limit`。
- 新增 `scripts/export_geojson.ts`：將 `nodes` 轉為 FeatureCollection，輸出 `public/data/nodes.json` 作為離線備援。

3) API 路徑強化
- 更新 `app/api/nodes/route.ts:1`：
  - 支援查詢參數：`bbox=minLon,minLat,maxLon,maxLat`、`category=station|busstop`、`limit`；預設為 V4.0 bbox。
  - 設定快取：`Cache-Control: public, max-age=30, stale-while-revalidate=300`。
  - 安全：僅使用服務端 `DATABASE_URL`，不讀取 client 變數。

4) PWA 與離線
- 新增 `public/sw.js`（簡易 Workbox/自製 SW）：快取 `/api/nodes` 響應與 `public/data/nodes.json`，並設定地圖樣式資源（mapbox tiles）走 runtime cache。
- `app/layout.tsx:27` 已連結 manifest；再加入 `<meta name="theme-color">` 已完成。

5) i18n Provider
- 建立 `src/i18n/provider.tsx`：以 `next-intl` 建立 `LocaleProvider`，支援 `zh`, `en`, `ja`，從瀏覽器語系推斷與覆寫。
- 在 `src/app/layout.tsx:26` 包覆 Provider，讓 `NodeCard` 與後續頁面可使用 `useLocale`。

6) 測試與品質
- 單元測試：加 `vitest` + `@testing-library/react`，為 `NodeCard` 與 bbox 過濾工具撰寫測試。
- E2E：加 `playwright`，流程：開地圖 → 取 `/api/nodes` → 斷言層渲染與點擊彈出卡片。
- Pre-commit：`husky` + `lint-staged`，執行 `eslint` 與 `typecheck`。

7) DX 與建置
- 修正 Next 警告：`next.config.ts:3` 設定 `turbopack: { root: __dirname }`（或明確到專案路徑）以消除 workspace root 誤判。
- 新增 `npm` 腳本：`typecheck`、`test`、`test:e2e`、`etl:odpt`、`export:geojson`、`dev:setup`。

8) 監控與日誌
- 新增 `lib/logger.ts`：提供 `info/warn/error`，API route 使用它記錄查詢參數與錯誤，避免敏感值。
- API 錯誤統一：`NextResponse.json({ error }, { status })`。

## 交付與驗證
- 執行 `npm run dev:setup` → `npm run fetch:odpt` → `npm run export:geojson`。
- 啟動 `npm run dev`，開啟 `http://localhost:3000`，驗證：
  - `/api/nodes` 回傳符合 bbox 的 GeoJSON，地圖顯示站點。
  - 點擊彈出卡片顯示對應語言與標籤。
  - 離線時改讀 `public/data/nodes.json`，地圖仍可顯示基本點位。
- 修正警告：確認終端不再出現 workspace root 提示。

## 安全
- 僅伺服端使用 `DATABASE_URL` 與 `SERVICE_ROLE`；不在客戶端暴露。
- Service Worker 只快取公開 API 與靜態資源，不緩存敏感請求或私有資料。

確認後我將逐步新增腳本與設定、強化 API 與 PWA，並完成測試與 DX 修正。
