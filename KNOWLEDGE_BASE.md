# LUTAGU Internal Knowledge Base

This document records the "Hidden Rules" and "Action-Effect" patterns learned during development to prevent regression and "Version Chaos".

## üèóÔ∏è Architectural Patterns

### 1. Service Mesh & Discovery
*   **Context**: `chat-api` depends on Rust services (`l4-routing-rs`, `l2-status-rs`).
*   **Rule**: Never hardcode `localhost` as a final fallback in production.
*   **Pattern**: 
    - Preferred variables: `L4_SERVICE_URL` and `L2_SERVICE_URL`.
    - `chat-api/health` must probe sub-services and report partial failure if they are unreachable.

### 2. UI Stacking Context (Z-Index)
*   **Context**: Language Switcher and Modals getting hidden.
*   **Rule**: High Z-index is insufficient if the parent creates a stacking context (e.g., `fixed`, `transform`).
*   **Pattern**: Use **React Portals** for all global overlays to render them at the bottom of `<body>`.

## üìú Data Standards

### L4 Station Knowledge (riding_knowledge)
*   **Format**: Must be a `LocalizedText` JSONB object.
*   **Structure**:
    ```json
    {
      "ja": "...",
      "en": "...",
      "zh": "..."
    }
    ```
*   **Trap**: Legacy data is string-only. API must handle fallback `if (typeof data === 'string') return { zh: data, ja: data, en: data };`.

## üß™ Action-Effect Patterns (Recorded Learnings)

| Date | Action | Primary Effect | Side Effects to Watch | Result |
| :--- | :--- | :--- | :--- | :--- |
| 2026-01-24 | Initial Reset | Cleaned up "Version Chaos" | Lost some local `.env` syncing | Success (Stabilized) |
| 2026-01-24 | Refactoring Demo Engine | Unified playback logic | None reported | TBD |

---
*Generated by Antigravity - Powered by Result-based Learning*
