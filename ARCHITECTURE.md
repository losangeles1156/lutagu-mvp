# LUTAGU System Architecture & Safety Standards

This document defines the core architecture and development standards for the LUTAGU MVP to prevent regressions and "Version Chaos".

## 1. Multilingual Data Integrity (Stage B Recovery)

All expert knowledge fields (e.g., `traps`, `hacks`, `facilities`) MUST use the **Multilingual JSONB** pattern.

-   **Standard Schema**:
    ```json
    {
      "en": "English content",
      "ja": "日本語の内容",
      "zh-TW": "繁體中文內容",
      "zh": "简体中文内容"
    }
    ```
-   **Strict Rule**: NEVER use monolingual strings in database fields that require localization.
-   **Validation**: Every database migration affecting L4/L5 tables MUST include a JSONB structure check.

## 2. Global UI Stability (Stage C Recovery)

### Portals for Overlays
To avoid **Stacking Context (Z-index) conflicts**, all global UI overlays MUST use `createPortal`.
-   **Target**: `document.body`
-   **Affected Components**: `LanguageSwitcher`, `FacilityDetailModal`, `LineBindingModal`, `SubscriptionModal`.
-   **Standard Implementation**:
    ```typescript
    if (!mounted) return null;
    return createPortal(<Component />, document.body);
    ```

### Unified Demo Engine
All demo/onboarding flows MUST use the `useDemoPlayback` hook.
-   **Playback Logic**: Centralized in `src/hooks/useDemoPlayback.ts`.
-   **Scripts**: Defined in `src/data/demoScripts.ts`.
-   **ID Normalization**: IDs MUST match between backend (`demoScenarios.ts`) and frontend (`demoScripts.ts`). (e.g., `overtourism`, NOT `01_overtourism`).

## 3. Service Connectivity (Stage A Recovery)

### Environment Variable Standards
To ensure consistent service discovery across dev/prod:
-   **L4 Microservice**: Supports BOTH `L4_SERVICE_URL` and `L4_ROUTING_API_URL`.
-   **Chat Backend**: Unified endpoint is `/api/agent/chat`.
-   **Health Checks**: Must probe all critical dependencies (Rust service, Supabase, Zeabur/LLM).

## 4. Maintenance & Verification

-   **Checklist**: Always run `python scripts/checklist.py` before deployment.
-   **E2E Path**: Standard "Happy Path" verification must be performed in `en`, `ja`, and `zh-TW`.

---
*Generated by Antigravity Recovery Protocol - February 2025*
