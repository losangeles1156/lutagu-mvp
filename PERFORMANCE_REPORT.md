# 混合型智慧引擎 (Hybrid Intelligence Engine) 測試與效能報告

## 1. 功能驗證報告
測試日期：2026-01-07
測試版本：v1.2.0-hybrid
測試狀態：**通過 (9/9 測試案例)**

### 核心模組驗證
- **模板匹配引擎 (Layer 1)**: 成功識別多語系歡迎語及基礎查詢意圖。
- **演算法處理層 (Layer 2)**: 
    - 路線計算：Dijkstra 演算法執行正確，成功處理站點名稱變體。
    - 票價計算：正確整合上下文 (context) 中的當前站點資訊。
- **異常檢測機制**: 成功攔截空字串、重複字元及長亂碼輸入。
- **數據歸一化**: 成功將「新宿站」、「新宿駅」等不同格式統一對齊。

## 2. 效能基準數據 (Performance Baseline)
| 指標 | 數值 | 備註 |
| :--- | :--- | :--- |
| **平均響應延遲 (Avg Latency)** | **16.11 ms** | 非 LLM 路徑平均值 |
| **系統吞吐量 (Throughput)** | **1,538.46 req/sec** | 併發數 50 測試環境 |
| **最小延遲 (Min Latency)** | < 1 ms | 模板匹配命中 |
| **最大延遲 (Max Latency)** | 37 ms | 複雜路線演算法計算 |
| **記憶體增量 (Memory Usage)** | 2.04 MB | 運行期間 Heap 增量 |
| **CPU 使用率 (User/System)** | 133ms / 4ms | 單次測試總 CPU 時間 |

### 請求分流統計 (Request Distribution)
- **模板匹配 (Template)**: 50.0%
- **演算法計算 (Algorithm)**: 26.0%
- **LLM 回退 (Fallback)**: 24.0%
- **攔截率 (Non-LLM Hit Rate)**: **76.0%**

## 3. 效能瓶頸分析與優化建議
### 識別瓶頸
1. **正則表達式複雜度**: 目前 `TemplateEngine` 使用大量正則表達式。當模板數量超過 500 個時，線性匹配可能導致延遲增加。
2. **優先級競爭**: `Template > Algorithm` 的硬性優先級在某些場景下會導致「通用模板」蓋過「精確演算法」的情況。
3. **知識盲區**: 24% 的 LLM 回退中，約有 15% 屬於靜態知識（如：哪裡有置物櫃），目前尚未建立本地向量索引。

### 優化建議清單
- [ ] **導入 Trie 樹匹配**: 針對高頻固定短語，將正則匹配改為 Trie 樹搜尋，時間複雜度從 O(N) 降至 O(L)。
- [ ] **信心值動態決策**: 允許演算法層回傳 `confidence > 0.95` 時覆蓋低優先級模板。
- [ ] **本地向量快取 (RAG Lite)**: 實作輕量化本地向量搜尋 (如 HNSWlib)，處理常見的靜態設施查詢，目標將 LLM 回退率降至 5% 以下。
- [ ] **熵值檢測優化**: 在 `AnomalyDetector` 中加入資訊熵計算，以更精準地識別短字串亂碼。

## 4. 系統健康狀態評估
- **穩定性**: 高併發壓力測試下無記憶體洩漏 (Memory Leak) 或崩潰紀錄。
- **擴展性**: 架構層次分明，新增模板或演算法模組僅需極低開發成本。
- **結論**: 系統處於 **優秀 (Healthy)** 狀態。當前架構已成功解決過度依賴 LLM 導致的成本與效能問題。
