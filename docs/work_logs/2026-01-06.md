# 開發日誌 - 2026-01-06

## 今日完成工作

### 1. 前端 UI 系統重新設計 (持續進行)

#### 完成項目：
- **SystemMenu 組件**: 新增 Google OAuth 與 Magic Link 登入整合
- **ChatPanel 對話面板**: 可調整大小、最小化/最大化控制
- **IntentSelector 意圖選擇器**: 6 種意圖類型的視覺化選擇器
- **翻譯整合**: 完成 zh-TW、ja、en 三種語言的意圖選擇器翻譯

### 2. L4 AI Agent 參數整合

#### 完成項目：
- 將 `selected_need` 參數從前端傳遞到 Dify API
- 修正參數名稱：`current_lat`/`current_lon` → `lat`/`lng`
- 新增 `station_name` 輔助函數從 node ID 提取可讀車站名稱
- 更新 `src/stores/appStore.ts` 新增 `selectedNeed` 狀態管理

---

## 開發困難與解決方式

### 困難 1：Dify Prompt 參數名稱與前端不一致

**問題描述**：
- Dify Prompt 期望 `lat`/`lng`，但前端代碼使用 `current_lat`/`current_lon`
- Dify Prompt 需要 `station_name`，但前端未提供
- Dify Prompt 需要 `selected_need`，但前端沒有實作意圖選擇器

**解決方式**：
1. 修改 [`src/components/chat/ChatPanel.tsx`](src/components/chat/ChatPanel.tsx:146-148) 中的 API 請求參數：
   ```typescript
   lat: mapCenter?.lat || null,
   lng: mapCenter?.lon || null,
   selected_need: selectedNeed || null,
   ```

2. 新增 `getStationName()` 輔助函數從 node ID 提取車站名稱：
   ```typescript
   function getStationName(nodeId: string | null): string {
       if (!nodeId) return '';
       const parts = nodeId.split('.');
       if (parts.length < 2) return nodeId;
       const stationPart = parts[parts.length - 1];
       return stationPart
           .split('_')
           .map(word => word.charAt(0).toUpperCase() + word.slice(1))
           .join(' ');
   }
   ```

3. 新增 [`IntentSelector.tsx`](src/components/chat/IntentSelector.tsx) 組件讓使用者選擇意圖

**預防建議**：
- 在開發新功能前，先確認 Prompt 所需的完整參數列表
- 建立前後端參數對照表，避免命名不一致
- 考慮使用 TypeScript 介面強制約束 API 參數類型

### 困難 2：翻譯鍵值不完整

**問題描述**：
- IntentSelector 使用 `useTranslations('chat.intent')` 但翻譯檔案缺少 `intent` 區段
- 清除按鈕需要 `common.clear` 與 `common.select` 鍵值

**解決方式**：
1. 更新所有翻譯檔案添加缺少的鍵值：
   - [`messages/zh-TW.json`](messages/zh-TW.json:413-420): 添加 `chat.intent` 區段
   - [`messages/ja.json`](messages/ja.json:27-42): 添加 `common.select/clear` 與 `chat.intent`
   - [`messages/en.json`](messages/en.json:399-426): 添加 `common.select/clear` 與 `chat.intent`

2. 翻譯結構：
   ```json
   "chat": {
       "intent": {
           "route": "路線",
           "status": "狀態",
           "facility": "設施",
           "ticket": "票券",
           "weather": "天氣",
           "time": "時間"
       }
   }
   ```

**預防建議**：
- 新增 UI 組件時，同步更新所有語言檔案
- 使用 `next-intl` 的預設值功能，在鍵值不存在時顯示鍵名稱本身
- 建立翻譯鍵值檢查腳本，在提交前自動驗證

### 困難 3：IntentSelector 視覺回饋不佳

**問題描述**：
- 意圖按鈕被選中時視覺區分度不足
- 清除按鈕在未選中意圖時仍然顯示

**解決方式**：
1. 修改 IntentSelector 樣式邏輯 ([`src/components/chat/IntentSelector.tsx`](src/components/chat/IntentSelector.tsx:52-57))：
   ```typescript
   className={`
       flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all active:scale-95
       ${isActive
           ? intent.color + ' shadow-sm scale-105 ring-2 ring-offset-1 ring-current'
           : 'bg-white border-gray-200 text-gray-500 hover:border-gray-300'
       }
   `}
   ```

2. 添加清除按鈕條件渲染：
   ```typescript
   {selectedNeed && (
       <button onClick={() => setSelectedNeed(null)} ...>
           ✕
       </button>
   )}
   ```

3. 添加觸覺回饋：
   ```typescript
   if (window.navigator.vibrate) {
       window.navigator.vibrate(10);
   }
   ```

**預防建議**：
- 為新 UI 組件建立 Storybook 故事，預覽不同狀態
- 在實現功能前，先完成視覺設計稿
- 使用 UI 組件庫的設計模式，保持一致性

---

## 技術債務

1. **站名本地化**: 目前 `getStationName()` 函數僅做簡單的大小寫格式化，應從資料庫取得真正的當地語言站名
2. **英文翻譯**: 部分較少使用的功能可能缺少英文翻譯
3. **錯誤處理**: API 錯誤時的用戶體驗可進一步優化

---

## 明日待辦

1. 繼續完成 UI 重新設計的剩餘部分
2. 測試意圖選擇器與 Dify Agent 的完整整合
3. 為移動設備添加更多觸控優化
4. 檢查並修補可能存在的 TypeScript 類型錯誤

---

## 學習要点總結

1. **Prompt-Driven Development**: 開發前端功能前，先確認 AI Agent Prompt 的需求，避免參數遺漏
2. **翻譯同步**: 新增 UI 元素時，應同步更新所有語言檔案
3. **狀態管理**: 使用 Zustand 時，注意各組件間的狀態同步問題
4. **錯誤處理**: API 錯誤應提供有意義的用戶訊息，而非顯示技術性錯誤
