# å·¥ä½œæ—¥èªŒ - 2026-01-04

## ğŸ“‹ ä»Šæ—¥å®Œæˆé …ç›®

### 1. L2 Live Display ä¿®å¾©
- âœ… ç§»é™¤ä¸é©ç•¶çš„ã€ŒOKã€ç‹€æ…‹ badgeï¼ˆTrainLineItemï¼‰
- âœ… ä¿®æ­£ JMA æ°£è±¡è­¦å ±åˆ†é¡é‚è¼¯ï¼ˆæ³¨æ„å ±â†’info, è­¦å ±â†’warning, ç‰¹åˆ¥è­¦å ±â†’criticalï¼‰
- âœ… JST æ™‚å€é–å®š `updatedAt` é¡¯ç¤º

### 2. L3 å¤–éƒ¨æœå‹™é€£çµæ›´æ–°
- âœ… æ›´æ–° Hands-Free Tourism é€£çµç‚º `https://cloak.ecbo.io/`

### 3. Dify Agent æ•´åˆ
- âœ… å»ºç«‹ `/api/dify/chat` ä»£ç†è·¯ç”±
- âœ… æ–°å¢ `DIFY_API_KEY` åˆ° `.env.local`
- âœ… æ›´æ–° 3 å€‹å‰ç«¯çµ„ä»¶ä½¿ç”¨ Dify ç«¯é»
- âœ… ç·¨å¯« LUTAGU Agent æç¤ºèªï¼ˆç²¾ç°¡ç‰ˆï¼‰
- âš ï¸ OpenAPI Schema å»ºç«‹ï¼ˆä»æœ‰å•é¡Œï¼‰

---

## âš ï¸ éŒ¯èª¤è¨˜éŒ„èˆ‡æ•™è¨“

### éŒ¯èª¤ 1: OpenAPI Schema åƒæ•¸åç¨±ä¸ä¸€è‡´
**å•é¡Œæè¿°ï¼š**
OpenAPI Schema ä¸­å®šç¾©çš„åƒæ•¸åç¨±èˆ‡å¯¦éš› API ä¸ä¸€è‡´ï¼Œå°è‡´ Dify é©—è­‰å¤±æ•—ã€‚

| Schema å®šç¾© | å¯¦éš› API åƒæ•¸ |
|------------|--------------|
| `stationId` | `station_id` |
| `hubId` | `query` |
| `query` (knowledge) | `type` + `id` |

**æ•™è¨“ï¼š**
> ğŸ“Œ **å»ºç«‹ OpenAPI Schema å‰ï¼Œå¿…é ˆå…ˆé©—è­‰å¯¦éš› API åƒæ•¸åç¨±**
> - ä½¿ç”¨ `grep "searchParams.get" src/app/api/xxx/route.ts` ç¢ºèª
> - ç”¨ `curl` æ¸¬è©¦ API æ˜¯å¦å›å‚³ 200

### éŒ¯èª¤ 2: Dify SSE äº‹ä»¶æ ¼å¼å·®ç•°
**å•é¡Œæè¿°ï¼š**
Dify å›å‚³çš„ SSE äº‹ä»¶ä½¿ç”¨ `agent_message`ï¼Œä½†å‰ç«¯åŸæœ¬åªç›£è½ `message`ã€‚

**ä¿®æ­£ï¼š**
```typescript
// éŒ¯èª¤ âŒ
if (data.event === 'message') { ... }

// æ­£ç¢º âœ…
if (data.event === 'agent_message' || data.event === 'message') { ... }
```

**æ•™è¨“ï¼š**
> ğŸ“Œ **æ•´åˆç¬¬ä¸‰æ–¹ API å‰ï¼Œå…ˆç”¨ `curl` è§€å¯Ÿå¯¦éš›å›å‚³æ ¼å¼**

### éŒ¯èª¤ 3: Dify ã€Œå·¥å…·å·²ç§»é™¤ã€å•é¡Œ
**å•é¡Œæè¿°ï¼š**
Dify Cloud é¡¯ç¤ºã€Œå·¥å…·å·²è¢«ç§»é™¤ã€ï¼Œä½†å·¥å…·å¯èƒ½ä»å¯é‹ä½œã€‚

**å¯èƒ½åŸå› ï¼š**
1. Dify UI é¡¯ç¤ºå•é¡Œï¼ˆå·²çŸ¥ bugï¼‰
2. CORS è¨­å®šä¸å…è¨± Dify ä¼ºæœå™¨è¨ªå•
3. OpenAPI ç‰ˆæœ¬å•é¡Œï¼ˆ3.0.0 vs 3.1.0ï¼‰

**æ•™è¨“ï¼š**
> ğŸ“Œ **å…ˆåœ¨ã€Œé™¤éŒ¯èˆ‡é è¦½ã€æ¸¬è©¦å·¥å…·æ˜¯å¦å¯¦éš›å¯ç”¨ï¼Œå†åˆ¤æ–·æ˜¯å¦ç‚º UI å•é¡Œ**

### éŒ¯èª¤ 4: æç¤ºèªéåº¦è¤‡é›œ
**å•é¡Œæè¿°ï¼š**
åˆç‰ˆæç¤ºèªè¦æ±‚æ¯æ¬¡å°è©±èª¿ç”¨å¤šå€‹å·¥å…·ï¼Œå°è‡´ï¼š
- å›æ‡‰é€Ÿåº¦æ…¢
- Token æ¶ˆè€—éé«˜
- æ¨¡å‹å®¹æ˜“å¿½ç•¥æŒ‡ä»¤

**ä¿®æ­£ï¼š**
æ¡ç”¨ **Lazy Calling** åŸå‰‡ - èƒ½ä¸èª¿ç”¨å°±ä¸èª¿ç”¨

**æ•™è¨“ï¼š**
> ğŸ“Œ **Agent æç¤ºèªæ‡‰éµå¾ªï¼šå¸¸è¦‹å•é¡Œç”¨ç¯„æœ¬ï¼Œè¤‡é›œå•é¡Œæ‰èª¿å·¥å…·**

---

## ğŸ“ æ–°å¢æª”æ¡ˆæ¸…å–®

```
dify/
â”œâ”€â”€ lutagu_agent_prompt.md      # LUTAGU Agent æç¤ºèª
â”œâ”€â”€ openapi_tools_v2.yaml       # OpenAPI 3.0 (èˆŠç‰ˆ)
â”œâ”€â”€ openapi_tools_v3.yaml       # OpenAPI 3.1.0 (ä¿®æ­£ç‰ˆ)
â”œâ”€â”€ openapi_tools_v4.yaml       # åƒæ•¸åç¨±ä¿®æ­£ç‰ˆ
â”œâ”€â”€ openapi_tools_v5.yaml       # æœ€çµ‚ç°¡åŒ–ç‰ˆ
â””â”€â”€ lutagu_tools_v2.json        # JSON å·¥å…·å®šç¾©

src/app/api/dify/chat/route.ts  # Dify ä»£ç† API
```

---

## ğŸ”® æ˜æ—¥å¾…è¾¦

1. [ ] ç¢ºèª Dify å·¥å…·èª¿ç”¨æ˜¯å¦æ­£å¸¸é‹ä½œ
2. [ ] å¦‚ä»æœ‰å•é¡Œï¼Œè€ƒæ…®æ”¹ç”¨ Dify å…§å»º HTTP Request å·¥å…·
3. [ ] Push ä»Šæ—¥è®Šæ›´åˆ° GitHub
4. [ ] æ¸…ç†å¤šé¤˜çš„ OpenAPI schema æª”æ¡ˆï¼ˆä¿ç•™ v5ï¼‰
