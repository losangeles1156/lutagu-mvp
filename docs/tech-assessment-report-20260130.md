# LUTAGU MVP 技術評估報告

**評估日期**: 2026-01-30
**專案版本**: v0.1.0
**評估範圍**: AI Agent、後端資料庫、前端組件、部署架構

---

## 1. 技術堆疊總覽

### 1.1 核心技術清單

| 類別 | 技術 | 版本 | 評估 |
|------|------|------|------|
| **前端框架** | Next.js (App Router) | 14.2.35 | ✅ 成熟穩定 |
| **UI 框架** | React | 18.x | ✅ 成熟穩定 |
| **樣式** | Tailwind CSS | 3.3.0 | ✅ 成熟穩定 |
| **地圖** | React Leaflet | 4.2.1 | ✅ 適合 MVP |
| **狀態管理** | Zustand | 4.5.0 | ✅ 輕量高效 |
| **資料庫** | Supabase (PostgreSQL) | - | ✅ 適合 MVP |
| **AI SDK** | Vercel AI SDK | 6.0.57 | ✅ 主流選擇 |
| **國際化** | next-intl | 3.5.0 | ✅ 成熟穩定 |
| **PWA** | next-pwa | 5.6.0 | ⚠️ 維護較少 |
| **監控** | Sentry | 10.36.0 | ✅ 企業級 |

### 1.2 AI 模型架構 (Trinity Architecture)

```
┌─────────────────────────────────────────────────────────────┐
│                    LUTAGU AI Trinity                        │
├─────────────────────────────────────────────────────────────┤
│  Gatekeeper (Gemini 2.5 Flash Lite)                        │
│  └─ 用途: 意圖分類、簡單查詢、快速路由                       │
│  └─ 回應時間: 20ms timeout                                  │
│  └─ Token 限制: 200                                         │
├─────────────────────────────────────────────────────────────┤
│  Brain (Gemini 3 Flash Preview)                            │
│  └─ 用途: 深度推理、多約束優化、複雜決策                     │
│  └─ 回應時間: 45ms timeout                                  │
│  └─ Token 限制: 600                                         │
├─────────────────────────────────────────────────────────────┤
│  Synthesizer (DeepSeek V3.2 via Zeabur)                    │
│  └─ 用途: 自然語言生成、情感語氣、長文本                     │
│  └─ 回應時間: 30ms timeout                                  │
│  └─ Token 限制: 700                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 效能評估

### 2.1 現有效能指標

| 指標 | 目前狀態 | 目標值 | 差距 |
|------|---------|--------|------|
| **Lighthouse Performance** | 82/100 | 90/100 | -8 |
| **LCP (Largest Contentful Paint)** | 2.1s | <1.5s | -0.6s |
| **TTI (Time to Interactive)** | 2.8s | <2.0s | -0.8s |
| **API 平均回應時間** | 待測量 | <500ms | 待驗證 |
| **AI Chat 回應時間** | 待測量 | <3s | 待驗證 |

### 2.2 快取策略分析

| 快取類型 | TTL | Max Size | 評估 |
|---------|-----|----------|------|
| L1 Places | 3 分鐘 | 200 | ✅ 合理 |
| API Response | 5 分鐘 | 1000 | ✅ 合理 |
| Station Data | 10 分鐘 | 500 | ✅ 合理 |
| Fare Data | 1 小時 | 500 | ✅ 票價穩定，適合長期快取 |
| Timetable | 15 分鐘 | 300 | ⚠️ 可能需要更短 TTL |
| Map Tiles | 1 小時 | 2000 | ✅ 合理 |

**問題點**：
- 目前使用 in-memory LRU cache，無法跨實例共享
- 無 Redis/KV 分散式快取（文件提到未來計畫）

### 2.3 AI Agent 效能瓶頸

**分析**：
- ✅ 限制迭代次數（3 次）控制成本
- ✅ 並行執行工具呼叫（`Promise.all`）
- ⚠️ 歷史剪除只保留 10 輪，可能影響上下文理解
- ⚠️ 無串流輸出優化（目前是 chunk 80 字元）

---

## 3. 安全性評估

### 3.1 現有安全措施

| 安全層 | 實作狀態 | 說明 |
|--------|---------|------|
| **CSP** | ✅ Report-Only 模式 | 建議正式上線前啟用強制模式 |
| **HSTS** | ✅ 生產環境啟用 | 1 年有效期 |
| **X-Frame-Options** | ✅ DENY | 防止點擊劫持 |
| **輸入驗證** | ✅ SecurityService | 實作於 Agent |
| **歷史剪除** | ✅ pruneHistory | 防止記憶體投毒 |
| **工具輸出清理** | ✅ sanitizeContent | 防止注入攻擊 |
| **Rate Limiting** | ⚠️ 需驗證 | 文件提到但需確認實作 |

### 3.2 安全建議

1. **CSP 強制模式**：目前為 Report-Only，商業上線需改為強制
2. **API Key 保護**：確認所有金鑰都在 server-side
3. **PII 加密**：已有配置，需驗證實際使用

---

## 4. 架構優缺點分析

### 4.1 優點 ✅

| 面向 | 優點 |
|------|------|
| **AI 架構** | Trinity 多模型設計，任務分工明確，成本可控 |
| **決策引擎** | L4 混合引擎結合規則、算法、LLM，降低 AI 依賴 |
| **快取設計** | 分層 TTL 策略，針對不同資料特性優化 |
| **安全性** | 多層防護，Agent 安全機制完善 |
| **國際化** | 原生多語言支援，JSONB 結構靈活 |
| **PWA** | 離線能力，Service Worker 快取策略 |
| **監控** | Sentry 整合 + 自建效能日誌 |

### 4.2 缺點/風險 ⚠️

| 面向 | 問題 | 影響 |
|------|------|------|
| **快取** | 無分散式快取 | 多實例無法共享，冷啟動效能差 |
| **AI 容錯** | 單一 Zeabur 閘道 | 閘道故障則 AI 全掛 |
| **Embedding** | 維度不一致 (1024 vs 768) | 切換模型需 padding |
| **PWA** | next-pwa 維護較少 | 未來可能需遷移 |
| **測試** | 33 個測試檔案，覆蓋率未知 | 需確認關鍵路徑覆蓋 |
| **HybridEngine** | 78KB 單一檔案 | 維護困難，需重構 |

---

## 5. 商業上線前必要優化

### 5.1 P0 - 關鍵（上線前必須完成）

| 項目 | 說明 | 預估工作量 |
|------|------|-----------|
| **分散式快取** | 引入 Upstash Redis (已有 dependency) | 2-3 天 |
| **CSP 強制模式** | 從 Report-Only 切換 | 0.5 天 |
| **Rate Limiting 驗證** | 確認 API 端點都有保護 | 1 天 |
| **AI 容錯增強** | 增加 Gemini 直連作為 Zeabur 備援 | 1-2 天 |
| **效能基準測試** | 建立 baseline，確認 SLA 達標 | 1-2 天 |

### 5.2 P1 - 重要（上線後 1-2 週內）

| 項目 | 說明 | 預估工作量 |
|------|------|-----------|
| **HybridEngine 重構** | 拆分 78KB 檔案為模組 | 3-5 天 |
| **測試覆蓋率提升** | 關鍵路徑達 80%+ | 3-5 天 |
| **Lighthouse 優化** | 目標 90+ 分數 | 2-3 天 |
| **LCP/TTI 優化** | 目標 <1.5s / <2s | 2-3 天 |
| **錯誤監控儀表板** | Admin 面板整合 Sentry | 2 天 |

### 5.3 P2 - 優化（上線後持續改進）

| 項目 | 說明 |
|------|------|
| **向量搜索加速** | 考慮 Pinecone/Weaviate 替代 |
| **邊緣快取** | CDN 層級快取常見查詢 |
| **Agent 串流優化** | 實作真正的 token streaming |
| **PWA 遷移** | 評估 Serwist 替代 next-pwa |

---

## 6. 商業功能缺口分析

### 6.1 核心功能完成度

| 功能 | 狀態 | 說明 |
|------|------|------|
| **地圖導航** | ✅ 完成 | Leaflet + OSM |
| **AI 對話** | ✅ 完成 | Trinity 架構 |
| **L4 推薦** | ✅ 完成 | 混合引擎 |
| **多語言** | ✅ 完成 | zh-TW/en/ja |
| **PWA 離線** | ✅ 完成 | Service Worker |
| **即時資料 (L2)** | ✅ 完成 | ODPT API |
| **便利設施 (L3)** | ✅ 完成 | OSM 資料 |

### 6.2 商業化功能缺口

| 功能 | 狀態 | 優先級 | 說明 |
|------|------|--------|------|
| **商業深度連結** | 📝 待開發 | P1 | GO Taxi / LUUP / Ecbo Cloak |
| **支付整合** | 📝 待開發 | P2 | 未來票券購買 |
| **使用者分析** | ⚠️ 部分 | P1 | 需增強行為追蹤 |
| **A/B 測試框架** | 📝 待開發 | P2 | 推薦效果驗證 |
| **反饋收集系統** | ⚠️ 部分 | P1 | 需完善 UI |

---

## 7. 部署與擴展性評估

### 7.1 目前部署架構

```
┌─────────────────────────────────────────────────────────┐
│                    Production                           │
├─────────────────────────────────────────────────────────┤
│  Vercel (主要)                                          │
│  ├─ Next.js Frontend + API Routes                      │
│  ├─ Edge Functions (部分 API)                          │
│  └─ ISR (增量靜態生成)                                  │
├─────────────────────────────────────────────────────────┤
│  Zeabur (AI Hub)                                       │
│  ├─ Unified AI Gateway (東京節點)                      │
│  ├─ n8n (ETL 工作流)                                   │
│  └─ 備用 API                                           │
├─────────────────────────────────────────────────────────┤
│  Supabase                                              │
│  ├─ PostgreSQL + PostGIS                               │
│  ├─ Auth (LINE Login)                                  │
│  └─ Storage                                            │
└─────────────────────────────────────────────────────────┘
```

### 7.2 擴展性評估

| 面向 | 評估 | 建議 |
|------|------|------|
| **前端** | ✅ Vercel 自動擴展 | 足夠 |
| **API** | ✅ Serverless 架構 | 足夠 |
| **資料庫** | ⚠️ Supabase 免費方案有限制 | 需升級 Pro |
| **AI** | ⚠️ Zeabur 單點 | 需增加備援 |
| **快取** | ❌ 無分散式 | 需引入 Redis |

---

## 8. 成本估算

### 8.1 預估月成本（10,000 MAU）

| 項目 | 預估成本 | 說明 |
|------|---------|------|
| **Vercel Pro** | $20/月 | 基礎方案 |
| **Supabase Pro** | $25/月 | 資料庫 |
| **Zeabur AI Hub** | $50-100/月 | 依用量 |
| **Gemini API** | $30-50/月 | 備援用量 |
| **Upstash Redis** | $10/月 | 快取 |
| **Sentry** | $26/月 | 監控 |
| **總計** | ~$160-230/月 | |

### 8.2 成本優化建議

1. **提高快取命中率**：減少 AI API 呼叫
2. **Template 優先策略**：簡單查詢不經過 LLM
3. **批次處理**：ODPT 資料批次更新而非即時
4. **冷啟動優化**：減少 Serverless 冷啟動次數

---

## 9. 總結與建議

### 9.1 整體評價

| 面向 | 評分 | 說明 |
|------|------|------|
| **架構設計** | ⭐⭐⭐⭐☆ (4/5) | Trinity AI 架構優秀，L4 混合引擎創新 |
| **程式碼品質** | ⭐⭐⭐⭐☆ (4/5) | TypeScript 嚴格模式，但 HybridEngine 需重構 |
| **效能** | ⭐⭐⭐☆☆ (3/5) | 基礎良好，快取和 LCP 需優化 |
| **安全性** | ⭐⭐⭐⭐☆ (4/5) | 多層防護，CSP 需啟用強制模式 |
| **可維護性** | ⭐⭐⭐☆☆ (3/5) | 測試覆蓋率需提升，文件完整 |
| **商業就緒度** | ⭐⭐⭐☆☆ (3/5) | 核心功能完成，商業連結待開發 |

### 9.2 上線前優先順序

```
Week 1:
├─ [P0] 分散式快取 (Upstash Redis)
├─ [P0] CSP 強制模式
├─ [P0] Rate Limiting 驗證
└─ [P0] 效能基準測試

Week 2:
├─ [P0] AI 容錯增強
├─ [P1] 錯誤監控告警
└─ [P1] 使用者分析增強

Week 3-4:
├─ [P1] 商業深度連結整合
├─ [P1] HybridEngine 重構
└─ [P1] 測試覆蓋率提升
```

### 9.3 結論

LUTAGU MVP 在技術架構上展現了**成熟的設計思維**，特別是：
- Trinity AI 多模型策略有效控制成本
- L4 混合決策引擎降低 LLM 依賴
- 多層安全防護機制

**主要風險**在於：
- 缺乏分散式快取影響多實例效能
- AI 閘道單點故障風險
- 測試覆蓋率未知

建議在 **2-3 週內**完成 P0/P1 項目後即可進行 **限量 Beta 測試**，同步收集實際效能數據和使用者反饋。

---

*報告生成日期: 2026-01-30*
*評估工具: Claude Code*
