---
name: map-display-rules
description: >
  LUTAGU åœ°åœ–ç¯€é»é¡¯ç¤ºè¦å‰‡ã€‚å®šç¾©äº”å±¤ç´šç¯€é»é¡¯ç¤ºé‚è¼¯ã€Hub èšåˆæ©Ÿåˆ¶ã€
  Zoom-based å¯è¦‹æ€§æ§åˆ¶ã€éµé“å…¬å¸é¡è‰²æ¨™æº–ã€‚ç¢ºä¿ UI é–‹ç™¼ç¬¦åˆè¦ç¯„ã€‚
---

# LUTAGU åœ°åœ–ç¯€é»é¡¯ç¤ºè¦å‰‡ (Map Display Rules)

## ğŸ“‹ ç›®çš„

è¦ç¯„å‰ç«¯åœ°åœ–ç¯€é»çš„é¡¯ç¤ºé‚è¼¯ï¼Œç¢ºä¿ï¼š
1. **äº”å±¤ç´šç¯€é»åˆ†å±¤é¡¯ç¤º** - ä¾é‡è¦æ€§èˆ‡ Zoom å±¤ç´šæ§åˆ¶å¯è¦‹æ€§
2. **Hub èšåˆæ©Ÿåˆ¶** - å¤§å‹æ¨ç´è‡ªå‹•èšåˆé„°è¿‘è»Šç«™
3. **éµé“å…¬å¸é…è‰²** - ä½¿ç”¨å®˜æ–¹å“ç‰Œè‰²é¡¯ç¤ºç¯€é»
4. **æ•ˆèƒ½æœ€ä½³åŒ–** - Viewport è™›æ“¬åŒ–æ¸²æŸ“

---

## ğŸ—ï¸ äº”å±¤ç´šç¯€é»é¡¯ç¤ºç³»çµ± (5-Tier Display System)

### **Tier 1: è¶…ç´šæ¨ç´ (Super Hub)**
- **é¡¯ç¤ºæ¢ä»¶**: **ä»»ä½• Zoom å±¤ç´šæ°¸é é¡¯ç¤ºåç¨±** (åŒ…æ‹¬é—œæ±å…¨å€è¦–åœ–)
- **å®šç¾©**: æ±äº¬æ ¸å¿ƒäº¤é€šæ¨ç´ + åœ‹éš›æ©Ÿå ´
- **ç¯€é»åˆ—è¡¨** (å…± 10 å€‹):
  ```
  æ±äº¬ç«™ã€ä¸Šé‡ã€æ± è¢‹ã€æ–°å®¿ã€æ¾€è°·ã€å“å·ã€éŠ€åº§ã€ç§‹è‘‰åŸ
  æˆç”°æ©Ÿå ´ (NRT)ã€ç¾½ç”°æ©Ÿå ´ (HND)
  ```
- **è³‡æ–™åº«æ¨™è¨˜**: `display_tier = 1`, `min_zoom_level = 1`
- **é è¨­ç‹€æ…‹**: **å•Ÿç”¨ Hub èšåˆæ¨¡å¼**

### **Tier 2: ä¸»è¦æ¨ç´ (Major Hub)**
- **é¡¯ç¤ºæ¢ä»¶**: `Zoom >= 12` é¡¯ç¤ºåç¨±
- **å®šç¾©**: å¤šç·šå…±æ§‹æˆ–è»Šç«™èšé›†ç¾¤
- **ç¯€é»ç¯„ä¾‹**:
  ```
  å¤§æ‰‹ç”ºã€æ·ºè‰ã€æŠ¼ä¸Šã€æ–°æ©‹ã€æ±æ—¥æœ¬æ©‹ã€æ¿±æ¾ç”ºã€å¾¡å¾’ç”ºã€
  å¾¡èŒ¶ä¹‹æ°´ã€é£¯ç”°æ©‹ã€ä¸­ç›®é»‘ã€æ—¥æš®é‡Œã€æ³‰å²³å¯ºã€å¤§äº•ç”ºã€è’²ç”°ç­‰
  ```
- **è³‡æ–™åº«æ¨™è¨˜**: `display_tier = 2`, `min_zoom_level = 12`
- **é è¨­ç‹€æ…‹**: **å•Ÿç”¨ Hub èšåˆæ¨¡å¼**

### **Tier 3: æ¬¡è¦æ¨ç´ (Minor Hub)**
- **é¡¯ç¤ºæ¢ä»¶**: `Zoom >= 14` é¡¯ç¤ºåç¨±
- **å®šç¾©**: æœ‰å…±æ§‹æˆ–ç›´é€šé‹è½‰çš„è»Šç«™
- **è³‡æ–™åº«æ¨™è¨˜**: `display_tier = 3`, `min_zoom_level = 14`

### **Tier 4: å¸¸ç”¨è»Šç«™ (Regular Station)**
- **é¡¯ç¤ºæ¢ä»¶**: `Zoom >= 15` é¡¯ç¤ºåç¨±
- **å®šç¾©**: ä¾æ¯æ—¥ä½¿ç”¨äººæ¬¡æ¬Šé‡æ’åºçš„è»Šç«™
- **æ’åºä¾æ“š**: `daily_passengers` æ¬„ä½ (é™åº)
- **è³‡æ–™åº«æ¨™è¨˜**: `display_tier = 4`, `min_zoom_level = 15`

### **Tier 5: ä¸€èˆ¬è»Šç«™ (Local Station)**
- **é¡¯ç¤ºæ¢ä»¶**: `Zoom >= 16` é¡¯ç¤ºåç¨±
- **å®šç¾©**: å–®ä¸€è»Šç«™ä¸”ä½¿ç”¨äººæ•¸è¼ƒå°‘
- **è³‡æ–™åº«æ¨™è¨˜**: `display_tier = 5`, `min_zoom_level = 16`

---

## ğŸ¨ ç¯€é»è¦–è¦ºè¦ç¯„

### **Hub èšåˆç¯€é» (Aggregated Hub)**

#### åç¨±é¡¯ç¤º
- **è¦å‰‡**: **åƒ…é¡¯ç¤ºåœ°åï¼Œä¸å«éµé“å…¬å¸æˆ–è·¯ç·šè³‡è¨Š**
- **ç¯„ä¾‹**:
  - âœ… æ­£ç¢º: `ä¸Šé‡`
  - âŒ éŒ¯èª¤: `JR ä¸Šé‡ç«™`ã€`ä¸Šé‡é§… (JR/æ±äº¬ãƒ¡ãƒˆãƒ­)`

#### é¡è‰²æ¨™æº–
- **è¦å‰‡**: æ¡ç”¨**ä¸»è¦ç¶“ç‡Ÿéµé“å…¬å¸çš„å®˜æ–¹å“ç‰Œè‰²**
- **ä¸»è¦éµé“å…¬å¸é…è‰²è¡¨**:

| éµé“å…¬å¸ | å“ç‰Œè‰² (HEX) | é©ç”¨ç¯„ä¾‹ |
|---------|-------------|---------|
| **JR æ±æ—¥æœ¬** | `#00AC4E` (ç¶ è‰²) | ä¸Šé‡ã€æ±äº¬ã€æ± è¢‹ã€æ–°å®¿ã€æ¾€è°·ã€å“å·ã€ç§‹è‘‰åŸ |
| **æ±äº¬ Metro** | `#149BDF` (è—ç¶ è‰²) | éŠ€åº§ã€å¤§æ‰‹ç”ºã€æ—¥æœ¬æ©‹ |
| **éƒ½ç‡Ÿåœ°ä¸‹éµ** | `#70BE1B` (æ·ºç¶ è‰²) | æ–°æ©‹ã€æŠ¼ä¸Š (ä¾å¾ªç”¨æˆ¶æŒ‡å®šä»£è¡¨è‰²) |
| **äº¬æ€¥é›»éµ** | `#E31E24` (ç´…è‰²) | æ³‰å²³å¯ºã€å“å· (äº¬æ€¥å„ªå…ˆæ™‚) |
| **æ±æ­¦éµé“** | `#003DA5` (æ·±è—è‰²) | æ·ºè‰ã€æŠ¼ä¸Š (æ±æ­¦å„ªå…ˆæ™‚) |
| **äº¬æˆé›»éµ** | `#003DA5` (æ·±è—è‰²) | æˆç”°æ©Ÿå ´ã€æ—¥æš®é‡Œ |
| **æ±äº¬å–®è»Œé›»è»Š** | `#0071BC` (è—è‰²) | ç¾½ç”°æ©Ÿå ´ |

#### åˆ¤æ–·ä¸»è¦ç¶“ç‡Ÿå…¬å¸è¦å‰‡
1. **å–®ä¸€å…¬å¸ç¶“ç‡Ÿ** â†’ ä½¿ç”¨è©²å…¬å¸å“ç‰Œè‰²
2. **å¤šå…¬å¸å…±æ§‹** â†’ ä¾ä»¥ä¸‹å„ªå…ˆé †åº:
   ```
   JR æ±æ—¥æœ¬ > æ±äº¬ Metro > éƒ½ç‡Ÿåœ°ä¸‹éµ > ç§éµ (äº¬æ€¥/æ±æ­¦/äº¬æˆç­‰)
   ```
3. **ç‰¹æ®Šæ¡ˆä¾‹**:
   - æˆç”°æ©Ÿå ´ â†’ äº¬æˆé›»éµè—è‰² (`#003DA5`)
   - ç¾½ç”°æ©Ÿå ´ â†’ æ±äº¬å–®è»Œè—è‰² (`#0071BC`)
   - éŠ€åº§ â†’ æ±äº¬ Metro è—ç¶ è‰² (`#149BDF`)

#### åœ–æ¨™è¦ç¯„
- **å°ºå¯¸**:
  - Tier 1: `40x40px` (æœ€å¤§)
  - Tier 2: `32x32px`
  - Tier 3-5: `24x24px`
- **å½¢ç‹€**: åœ“è§’çŸ©å½¢ (`border-radius: 8px`)
- **é‚Šæ¡†**: ç™½è‰² `2px solid #FFFFFF`
- **é™°å½±**: `box-shadow: 0 2px 8px rgba(0,0,0,0.15)`
- **åœ–ç¤º**: ä½¿ç”¨ emoji `ğŸš‡` æˆ–éµé“å…¬å¸ Logo (å¦‚æœ‰æˆæ¬Š)

---

## ğŸ”— Hub èšåˆæ©Ÿåˆ¶ (Hub Aggregation)

### è‡ªå‹•èšåˆè¦å‰‡
- **è§¸ç™¼æ¢ä»¶**: ç¯€é»æ¨™è¨˜ç‚º `display_tier <= 2` ä¸” `is_hub = true`
- **èšåˆç¯„åœ**: 220 å…¬å°º (ä½¿ç”¨ Haversine å…¬å¼è¨ˆç®—)
- **æœ€å¤§æˆå“¡æ•¸**: 18 å€‹å­ç¯€é»
- **æ’åºé‚è¼¯**: ä¾è·é›¢ç”±è¿‘è‡³é æ’åº

### å±•é–‹é‚è¼¯
- **é è¨­ç‹€æ…‹**: Hub èšåˆç¯€é»**æ”¶åˆé¡¯ç¤ºå–®ä¸€æ¨™è¨˜**
- **é»æ“Šå±•é–‹**: é¡¯ç¤ºæ‰€æœ‰æˆå“¡è»Šç«™ (æœ€å¤š 18 å€‹)
- **å±•é–‹è¦–è¦º**: æˆå“¡ç¯€é»ä»¥æ”¾å°„ç‹€æ’åˆ—åœ¨ Hub å‘¨åœ

### å¾Œå°ç®¡ç†åŠŸèƒ½
- **æ‰‹å‹•è¨­ç½®**: å¾Œå°å¯æŒ‡å®šä»»æ„ç¯€é»ç‚º Hub
- **èª¿æ•´ç¯„åœ**: å¯è‡ªè¨‚èšåˆåŠå¾‘ (é è¨­ 220m)
- **è§£é™¤èšåˆ**: å¯å°‡ Hub è½‰ç‚ºä¸€èˆ¬ç¯€é»é¡¯ç¤º
- **å„ªå…ˆç´šèª¿æ•´**: å¯æ‰‹å‹•è®Šæ›´ `display_tier` å±¤ç´š

---

## ğŸ—ºï¸ Zoom-Based é¡¯ç¤ºé‚è¼¯

### æ ¸å¿ƒå‡½æ•¸

```typescript
/**
 * åˆ¤æ–·ç¯€é»æ˜¯å¦æ‡‰è©²é¡¯ç¤º (Marker å¯è¦‹æ€§)
 */
function shouldShowNode(node: Node, currentZoom: number): boolean {
  return currentZoom >= node.min_zoom_level;
}

/**
 * åˆ¤æ–·ç¯€é»åç¨±æ˜¯å¦æ‡‰è©²é¡¯ç¤º (Label å¯è¦‹æ€§)
 */
function shouldShowLabel(node: Node, currentZoom: number): boolean {
  // Tier 1: æ°¸é é¡¯ç¤ºåç¨±
  if (node.display_tier === 1) return true;

  // Tier 2: Zoom >= 12 é¡¯ç¤º
  if (node.display_tier === 2) return currentZoom >= 12;

  // Tier 3: Zoom >= 14 é¡¯ç¤º
  if (node.display_tier === 3) return currentZoom >= 14;

  // Tier 4-5: Zoom >= 15 é¡¯ç¤º
  return currentZoom >= 15;
}

/**
 * å–å¾—ç¯€é»ä¸»è¦éµé“å…¬å¸é¡è‰²
 */
function getNodeColor(node: Node): string {
  const operatorPriority = [
    { name: 'JRæ±æ—¥æœ¬', color: '#00AC4E' },
    { name: 'æ±äº¬ãƒ¡ãƒˆãƒ­', color: '#149BDF' },
    { name: 'æ±äº¬éƒ½äº¤é€šå±€', color: '#B6007A' },
    { name: 'äº¬æ€¥é›»é‰„', color: '#E31E24' },
    { name: 'æ±æ­¦é‰„é“', color: '#003DA5' },
    { name: 'äº¬æˆé›»é‰„', color: '#003DA5' },
  ];

  // ç‰¹æ®Šæ¡ˆä¾‹è™•ç†
  if (node.id.includes('Narita')) return '#003DA5'; // æˆç”°æ©Ÿå ´
  if (node.id.includes('Haneda')) return '#0071BC'; // ç¾½ç”°æ©Ÿå ´

  // å¾ node.operators æ‰¾ç¬¬ä¸€å€‹åŒ¹é…çš„å…¬å¸
  for (const op of operatorPriority) {
    if (node.operators?.some(o => o.includes(op.name))) {
      return op.color;
    }
  }

  // é è¨­ç°è‰²
  return '#6B7280';
}
```

### Zoom å±¤ç´šå°æ‡‰è¡¨

| Zoom Level | å¯è¦‹ç¯€é»å±¤ç´š | èªªæ˜ |
|-----------|------------|------|
| 1-11 | Tier 1 only | åƒ…è¶…ç´šæ¨ç´ (é—œæ±å…¨å€) |
| 12-13 | Tier 1-2 | ä¸»è¦æ¨ç´é–‹å§‹é¡¯ç¤º |
| 14 | Tier 1-3 | æ¬¡è¦æ¨ç´é–‹å§‹é¡¯ç¤º |
| 15 | Tier 1-4 | å¸¸ç”¨è»Šç«™é–‹å§‹é¡¯ç¤º |
| 16+ | Tier 1-5 | æ‰€æœ‰è»Šç«™é¡¯ç¤º |

---

## âš¡ æ•ˆèƒ½æœ€ä½³åŒ–è¦å‰‡

### Viewport è™›æ“¬åŒ–
- **ä½¿ç”¨ Hook**: `useViewportBounds` + `useVisibleMarkers`
- **åŸç†**: åªæ¸²æŸ“ç•¶å‰ Viewport å…§çš„ç¯€é»
- **æ•ˆèƒ½æŒ‡æ¨™**: 1000+ ç¯€é»ä¸‹ç¶­æŒ 60fps

### Memoization ç­–ç•¥
```typescript
// âœ… æ­£ç¢º: ä½¿ç”¨ useMemo å¿«å–éæ¿¾çµæœ
const visibleNodes = useMemo(() => {
  return allNodes.filter(n => shouldShowNode(n, zoom));
}, [allNodes, zoom]);

// âœ… æ­£ç¢º: ä½¿ç”¨ memo åŒ…è£é«˜é »æ¸²æŸ“å…ƒä»¶
const NodeMarker = memo(({ node, zoom }) => {
  // ...
});
```

### é¿å…éåº¦æ¸²æŸ“
- âŒ ç¦æ­¢åœ¨ `map.on('move')` ä¸­ç›´æ¥æ“ä½œ DOM
- âŒ ç¦æ­¢åœ¨æ¯æ¬¡ render æ™‚é‡æ–°è¨ˆç®—é¡è‰²
- âœ… ä½¿ç”¨ `zoomend` äº‹ä»¶è€Œé `zoom` äº‹ä»¶
- âœ… é å…ˆè¨ˆç®—ä¸¦å¿«å–ç¯€é»é¡è‰²æ–¼è³‡æ–™åº«

---

## ğŸ¯ å…¶ä»–åœ–å±¤é¡¯ç¤ºè¦å‰‡

### L1 Places Layer (å•†æ¥­ POI)
- **é¡¯ç¤ºæ¢ä»¶**: `Zoom >= 16`
- **åŸå› **: é¿å…ä½ Zoom æ™‚åœ°åœ–éåº¦æ“æ“ 
- **åœ–æ¨™è¦ç¯„**:
  - åˆä½œåº—å®¶: é‡‘è‰²æ¼¸å±¤ `24x24px` + â­ emoji
  - ä¸€èˆ¬åº—å®¶: åˆ†é¡é¡è‰²åœ“é» `10x10px`

### å…¶ä»–åœ–å±¤
- **TrainLayer** (åˆ—è»Šå³æ™‚ä½ç½®): æ ¹æ“šéœ€æ±‚é¡¯ç¤º
- **PedestrianLayer** (è¡Œäººè·¯ç·š): `Zoom >= 17`
- **RouteLayer** (å°èˆªè·¯ç·š): æ°¸é é¡¯ç¤º (å¦‚æœ‰å•Ÿç”¨)

---

## ğŸ—„ï¸ è³‡æ–™åº« Schema è¦æ±‚

### nodes è¡¨å¿…è¦æ¬„ä½
```sql
CREATE TABLE nodes (
  id UUID PRIMARY KEY,
  name JSONB NOT NULL, -- å¤šèªç³»åç¨±
  type TEXT NOT NULL,
  location GEOMETRY(Point, 4326) NOT NULL,

  -- [æ–°å¢] é¡¯ç¤ºå±¤ç´šæ§åˆ¶æ¬„ä½
  display_tier INTEGER DEFAULT 5, -- 1-5 å±¤ç´š
  min_zoom_level INTEGER DEFAULT 16, -- æœ€å°é¡¯ç¤º Zoom
  daily_passengers INTEGER, -- æ¯æ—¥ä¹˜å®¢æ•¸ (ç”¨æ–¼ Tier 4 æ’åº)

  -- Hub èšåˆç›¸é—œ
  is_hub BOOLEAN DEFAULT false,
  parent_hub_id UUID REFERENCES nodes(id),
  hub_aggregation_radius INTEGER DEFAULT 220, -- èšåˆåŠå¾‘ (å…¬å°º)

  -- éµé“å…¬å¸è³‡è¨Š
  operators JSONB, -- ["JRæ±æ—¥æœ¬", "æ±äº¬ãƒ¡ãƒˆãƒ­"]
  primary_operator TEXT, -- ä¸»è¦ç¶“ç‡Ÿå…¬å¸
  brand_color TEXT, -- é å…ˆè¨ˆç®—çš„å“ç‰Œè‰² (HEX)

  -- å…¶ä»–æ¬„ä½...
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•å„ªåŒ–
CREATE INDEX idx_nodes_display_tier ON nodes(display_tier);
CREATE INDEX idx_nodes_zoom_level ON nodes(min_zoom_level);
CREATE INDEX idx_nodes_parent_hub ON nodes(parent_hub_id);
```

### Tier 1 ç¯€é»åˆå§‹åŒ–ç¯„ä¾‹
```sql
-- ä¸Šé‡ç«™ (JR ç¶ è‰²)
UPDATE nodes SET
  display_tier = 1,
  min_zoom_level = 1,
  is_hub = true,
  primary_operator = 'JRæ±æ—¥æœ¬',
  brand_color = '#00AC4E',
  operators = '["JRæ±æ—¥æœ¬", "æ±äº¬ãƒ¡ãƒˆãƒ­"]'::jsonb
WHERE name->>'ja' = 'ä¸Šé‡é§…';

-- æˆç”°æ©Ÿå ´ (äº¬æˆè—è‰²)
UPDATE nodes SET
  display_tier = 1,
  min_zoom_level = 1,
  is_hub = true,
  primary_operator = 'äº¬æˆé›»é‰„',
  brand_color = '#003DA5',
  operators = '["äº¬æˆé›»é‰„", "JRæ±æ—¥æœ¬"]'::jsonb
WHERE id = 'odpt:Station:Airport.Narita';
```

---

## âœ… é–‹ç™¼æª¢æŸ¥æ¸…å–® (Checklist)

### æ–°å¢ç¯€é»æ™‚
- [ ] è¨­ç½®æ­£ç¢ºçš„ `display_tier` (1-5)
- [ ] è¨­ç½®å°æ‡‰çš„ `min_zoom_level`
- [ ] å¡«å¯« `operators` é™£åˆ—
- [ ] è¨ˆç®—ä¸¦è¨­ç½® `brand_color`
- [ ] å¦‚ç‚º Hubï¼Œè¨­ç½® `is_hub = true`

### ä¿®æ”¹åœ°åœ– UI æ™‚
- [ ] ç¢ºä¿ Zoom é‚è¼¯ç¬¦åˆäº”å±¤ç´šè¦ç¯„
- [ ] Hub åç¨±åƒ…é¡¯ç¤ºåœ°å (ç„¡å…¬å¸å¾Œç¶´)
- [ ] é¡è‰²ä½¿ç”¨ `brand_color` æ¬„ä½
- [ ] ä½¿ç”¨ `useMemo` é¿å…éåº¦è¨ˆç®—
- [ ] Viewport è™›æ“¬åŒ–æ­£å¸¸é‹ä½œ

### æ•ˆèƒ½æ¸¬è©¦
- [ ] 1000+ ç¯€é»ä¸‹æµæš¢åº¦ (60fps)
- [ ] Zoom åˆ‡æ›ç„¡å¡é “
- [ ] Hub å±•é–‹/æ”¶åˆå‹•ç•«æµæš¢

---

## ğŸ“š ç›¸é—œæª”æ¡ˆ

- **å‰ç«¯å…ƒä»¶**: `src/components/map/MapContainer.tsx`
- **Node Layer**: `src/components/map/HubNodeLayer.tsx`
- **L1 Layer**: `src/components/map/L1Layer.tsx`
- **Hooks**: `src/hooks/map/useViewportBounds.ts`, `src/hooks/map/useVisibleMarkers.ts`
- **è³‡æ–™åº« Migration**: `supabase/migrations/YYYYMMDDHHMMSS_add_display_tier.sql`

---

## ğŸš¨ é‡è¦æé†’

1. **Tier 1 ç¯€é»æ°¸é é¡¯ç¤ºåç¨±** - ä»»ä½• Zoom å±¤ç´šéƒ½ä¸å¯éš±è—
2. **Hub åç¨±ä¸å«å…¬å¸è³‡è¨Š** - åƒ…åœ°å (ä¾‹: `ä¸Šé‡` è€Œé `JRä¸Šé‡ç«™`)
3. **é¡è‰²ç”±ä¸»è¦å…¬å¸æ±ºå®š** - åš´æ ¼éµå¾ªå„ªå…ˆç´šè¦å‰‡
4. **æ•ˆèƒ½å„ªå…ˆ** - å‹™å¿…ä½¿ç”¨ Viewport è™›æ“¬åŒ–
5. **å¾Œå°å¯èª¿æ•´** - æ‰€æœ‰è¦å‰‡å¯é€éå¾Œå°äººå·¥è¦†å¯«

---

*æ­¤ Skill æœ€å¾Œæ›´æ–°: 2026-01-24*
