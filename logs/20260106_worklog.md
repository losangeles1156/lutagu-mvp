#AI開發 #問題排查 #L4介面優化 #Dify整合

# 20260106 工作日誌

## 開發進度

### 已完成工作項目
- **L4 介面系統性修復**：解決了因 `wards` API 動態路由在 Webpack 環境下使用 `require` 導致的靜態路徑生成錯誤。
- **AI Agent 對話功能整合**：在 [L4_Dashboard.tsx](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/components/node/L4_Dashboard.tsx) 標頭成功新增「問 LUTAGU」按鈕，並透過 `appStore` 觸發對話框。
- **偏好設定選單重設計**：優化了 [L4_Dashboard.tsx](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/components/node/L4_Dashboard.tsx) 的需求標籤（Demand Chips），改為更符合現有 MVP 流程的分類與排序。
- **系統穩定性與類型修復**：
  - 修復了 `rateLimitService.ts` 的 Map 類型不匹配與方法棄用問題。
  - 解決了 [L1_DNA.tsx](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/components/node/L1_DNA.tsx) 的靜態資料類型錯誤。
  - 修正了 [SystemMenu.tsx](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/components/ui/SystemMenu.tsx) 缺失 `useMemo` 導入的問題。
- **環境驗證**：通過 `npm run typecheck` 與 `npm run lint`，並於本地端（Port 3100）驗證頁面加載。
- **L3 設施名稱雙語化**：實作 `getBilingualString` 工具函數，將 L3 設施列表改為「翻譯名稱 (原文名稱)」格式，提升跨語言易用性。
- **第三方服務整合 (VACAN)**：在 [L2_Live.tsx](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/components/node/L2_Live.tsx) 整合 VACAN 實時人流地圖連結，並完成多語系支援（中/英/日）。
- **L2 效能優化**：重構 [SmartWeatherCard.tsx](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/components/ui/SmartWeatherCard.tsx)，改採「初始資料立即顯示 + 背景水合」策略，消除天氣資訊載入延遲。

### 當前進行中任務
- **L4 知識庫資料擴充**（預計 2026-01-07 18:00 完成）：持續完善各大轉運站的 L4 專家建議資料。

### 明日規劃事項
- 進行 Dify Agent 在不同行動裝置上的 UI 適應性測試。
- 完善 L4 儀表板與地圖組件之間的互動反饋（如點擊標籤後地圖標記的變更）。
- **環境變數配置**：解決 Supabase URL/Key 缺失問題，以利進行 L4 功能的自動化驗證。
- **UI 重設計 (UI Redesign)**：重啟被暫停的 UI 優化任務，統一 L1-L3 的視覺風格。

## 技術難點與解決方案

### 遇到的具體問題
- **問題描述**：L4 介面出現「系統錯誤」，且開發環境出現 `ReferenceError: require is not defined`。
- **重現步驟**：執行 `npm run build` 或在開發模式下造訪動態路由 `/api/wards/[wardId]`。
- **錯誤訊息**：`Error: Dynamic Server Usage: Route /api/wards/[wardId] couldn't be rendered statically because it used generateStaticParams.`

### 嘗試過的解決方法
1. 檢查 `generateStaticParams` 的資料來源，確認 Supabase 連線正常。
2. 懷疑是環境變數缺失，重新配置 `.env.local`。
3. **定位原因**：發現程式碼中使用了 `require('path')` 等 Node.js 原生模組，但在 Next.js 14 的 Webpack 封裝下會出錯。

### 最終採用的解決方案
- **程式碼調整**：將原生 Node.js 模組調用替換為符合 ESM 規範的 `import`，並在 API Route 中強制使用動態渲染。
```typescript
// src/app/api/wards/[wardId]/route.ts
export const dynamic = 'force-dynamic';
// 移除 require，統一使用 import
import { NextResponse } from 'next/server';
```

### 學到的經驗教訓
- 在 Next.js 14 的 API Routes 中，應優先考慮 `force-dynamic` 策略以處理動態參數，避免靜態路徑生成時的複雜模組相依性問題。
- 嚴格遵守 ESM 規範，避免在瀏覽器或 Webpack 環境混用 `require`。

### L2 天氣組件效能瓶頸
- **問題描述**：使用者回報 L2 頁面天氣卡片出現速度較慢，有明顯的載入中狀態。
- **原因分析**：原設計在 `L2_Live` 父組件 fetch 一次天氣，`SmartWeatherCard` 子組件 mount 後又再次 fetch `/api/weather/live`，造成不必要的網路請求與渲染阻塞。
- **解決方案**：
  1. 移除 `L2_Live` 中多餘的的客戶端 fetch `useEffect`。
  2. 將 SSR 階段獲取的 `l2.weather` 資料直接作為 `initialData` 傳遞給 `SmartWeatherCard`。
  3. 修改 `SmartWeatherCard` 初始化邏輯，優先使用 `initialData` 渲染 UI，隨後僅異步加載 AI 建議與詳細警報。

## 協作資訊

### 需要其他智能體協助的事項
- **資料清理**：需要自動化腳本協助清理 `l4_knowledge_embeddings` 中的重複資料。

### 已知但尚未解決的問題
- **L4 頁面水合警告**：部分靜態組件在切換語言時會出現輕微的水合不一致（緊急程度：**低**）。

## 工具與資源
- **Node.js 版本**：v20.x
- **Next.js 版本**：14.2.35
- **主要檔案連結**：
  - [L4_Dashboard.tsx](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/components/node/L4_Dashboard.tsx)
  - [route.ts (Wards API)](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/app/api/wards/%5BwardId%5D/route.ts)
  - [appStore.ts](file:///Users/zhuangzixian/Documents/BambiGO_MVP/src/stores/appStore.ts)
